<%
# MySQL my.cnf tuning
MEMCAP = memcap

# innodb_buffer_pool_size
INNODB_BUFFER_POOL_SIZE = case MEMCAP
  when 0..132 then "32M"
  when 133..264 then "#{MEMCAP / 2}M"
  else
    "#{(MEMCAP * 0.65).to_i}M"
end

KEY_BUFFER_SIZE = case MEMCAP
  when 0..132 then type == 'mariadb' ? '8M' : '16M'
  when 133..264 then '16M'
  when 265..4096 then '32M'
  else
    '64M'
end

# back_log
BACK_LOG = MEMCAP > 8000 ? 128 : 64

# max_connections
MAX_CONNECTIONS = case MEMCAP
  when 0..1000 then 200
  when 1001..2000 then 500
  when 2001..3000 then 1000
  when 3001..5000 then 2000
  else
    3000
  end

# table_cache
TABLE_CACHE = case (MEMCAP / 4)
  when 0..256 then 256
  else
    512
  end

# thread_cache_size
THREAD_CACHE_SIZE = case (MAX_CONNECTIONS / 2)
  when 0..1000 then 100
  else
    1000
  end
-%>
#
# nanobox MySQL configuration
#

# The following options will be passed to all MySQL clients
[client]
port                  = 3306
socket                = /tmp/mysqld.sock
default-character-set = utf8

# The MySQL server
[mysqld]
user                    = gonano
port                    = 3306
basedir                 = /data
datadir                 = /data/var/db/mysql
socket                  = /tmp/mysqld.sock
bind-address            = 0.0.0.0
default-storage-engine  = innodb
character-set-server    = utf8
skip-external-locking
log_warnings
skip_name_resolve
#default-time-zone='UTC'
<% if version >= 5.6 -%>
explicit_defaults_for_timestamp
<% end -%>
<% if boxfile[:event_scheduler] && ( ['true', 'On', 'on', '1'].include? boxfile[:event_scheduler].to_s ) -%>
event_scheduler=on
<% end -%>

# MyISAM settings
key_buffer_size         = <%= boxfile[:myisam_key_buffer_size] || KEY_BUFFER_SIZE%>
sort_buffer_size        = <%= boxfile[:myisam_sort_buffer_size] %>
read_buffer_size        = <%= boxfile[:myisam_read_buffer_size] %>
read_rnd_buffer_size    = <%= boxfile[:myisam_read_rnd_buffer_size] %>
myisam_sort_buffer_size = <%= boxfile[:myisam_myisam_sort_buffer_size] %>
myisam-recover-options  = <%= boxfile[:myisam_recover] %>

# InnoDB settings
innodb_data_home_dir            = /data/var/db/mysql
innodb_log_group_home_dir       = /data/var/db/mysql
innodb_data_file_path           = ibdata1:100M:autoextend
innodb_buffer_pool_size         = <%= boxfile[:innodb_buffer_pool_size] || INNODB_BUFFER_POOL_SIZE %>
innodb_log_file_size            = 400M
innodb_additional_mem_pool_size = <%= boxfile[:innodb_additional_mem_pool_size] %>
innodb_log_buffer_size          = <%= boxfile[:innodb_log_buffer_size] %>
innodb_flush_log_at_trx_commit  = <%= boxfile[:innodb_flush_log_at_trx_commit] %>
innodb_lock_wait_timeout        = <%= boxfile[:innodb_lock_wait_timeout] %>
innodb_doublewrite              = <%= boxfile[:innodb_doublewrite] %>
innodb_io_capacity              = <%= boxfile[:innodb_io_capacity] %>
innodb_read_io_threads          = <%= boxfile[:innodb_read_io_threads] %>
innodb_write_io_threads         = <%= boxfile[:innodb_write_io_threads] %>
innodb_file_per_table

<% if type == 'mariadb' -%>
# Aria
aria_pagecache_buffer_size      = 8M
aria_sort_buffer_size           = 32M
<% end -%>

<% if boxfile[:slow_query_log] -%>
# Slow query log settings
# The default logs all full table scans,tmp tables,filesorts on disk queries
slow_query_log_file = /var/log/mysql/slowquery.log
slow_query_log      = 1
<% end -%>

# Other general MySQL settings
performance-schema        = <%= boxfile[:performance_schema] %>
table_open_cache          = <%= boxfile[:table_open_cache] || TABLE_CACHE %>
thread_cache_size         = <%= boxfile[:thread_cache_size] || THREAD_CACHE_SIZE %>
query_cache_type          = <%= boxfile[:query_cache_type] %>
back_log                  = <%= boxfile[:back_log] || BACK_LOG %>
thread_concurrency        = <%= boxfile[:thread_concurrency] || (`mpstat | tail -n +2 | wc -l`.to_i * 2 + 2) %>
tmpdir                    = /var/tmp
max_connections           = <%= boxfile[:max_connections] || MAX_CONNECTIONS %>
max_allowed_packet        = <%= boxfile[:max_allowed_packet] %>
max_join_size             = <%= boxfile[:max_join_size] %>
net_buffer_length         = <%= boxfile[:net_buffer_length] %>
thread_stack              = <%= boxfile[:thread_stack] %>
tmp_table_size            = <%= boxfile[:tmp_table_size] %>
max_heap_table_size       = <%= boxfile[:max_heap_table_size] %>
group_concat_max_len      = <%= boxfile[:group_concat_max_len] %>

<% if boxfile[:allow_suspicious_udfs] and ['On', 'on', '1'].include? boxfile[:allow_suspicious_udfs] -%>
allow_suspicious_udfs
<% end -%>
<% if boxfile[:ansi] -%>
ansi
<% end -%>

# Full Text Settings
<% if boxfile[:ft_max_word_len] and boxfile[:ft_max_word_len] >= 10 -%>
ft_max_word_len = <%= boxfile[:ft_max_word_len] %>
<% end -%>
<% if boxfile[:ft_min_word_len] and boxfile[:ft_min_word_len] >= 1 -%>
ft_min_word_len = <%= boxfile[:ft_min_word_len] %>
<% end -%>
<% if boxfile[:ft_query_expansion_limit] and boxfile[:ft_query_expansion_limit] >= 0 and boxfile[:ft_query_expansion_limit] <= 1000 -%>
ft_query_expansion_limit = <%= boxfile[:ft_query_expansion_limit] %>
<% end -%>
<% if boxfile[:ft_stopword_file] -%>
ft_stopword_file = <%= boxfile[:ft_stopword_file] %>
<% end -%>

# Plugin Configuration
plugin_dir=/data/lib/mysql/plugin
<% plugins.each do |plugin| -%>
plugin-load=<%= plugin[:name] %>=<%= plugin[:soname] %>
<% end -%>

# Plugin-Specific Configuration
<% if boxfile[:audit_log] and boxfile[:plugins].include? 'audit_log' -%>
audit_log = <%= boxfile[:audit_log] %>
<% end -%>

# Replication settings (master to slave)
# This is not enabled by default.  There are more steps
# to this besides uncommenting the lines below.
# See: http://wiki.joyent.com/wiki/display/jpc2/Replication
#
<% if boxfile[:binlog] -%>
binlog_format     = ROW
log-bin           = /data/var/db/mysql/bin.log
max_binlog_size   = 100M
expire_logs_days  = 7
<% end -%>
log-error         = /var/log/mysql/error.log

[mysqldump]
quick
max_allowed_packet = 16M

[mysql]
no-auto-rehash
# Remove the next comment character if you are not familiar with SQL
#safe-updates

[myisamchk]
key_buffer_size   = 128M
sort_buffer_size  = 128M
read_buffer       = 2M
write_buffer      = 2M

[mysqlhotcopy]
interactive-timeout
